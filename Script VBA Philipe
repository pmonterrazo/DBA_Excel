Sub deletarConsultas()
    Dim pq As Object
    For Each pq In ThisWorkbook.Queries
        pq.Delete
    Next
 End Sub
Sub deletarQuerys()
    Dim qt As QueryTable
    Dim WSh As Worksheet
    For Each WSh In ThisWorkbook.Worksheets
        For Each qt In WSh.QueryTables
              qt.Delete
         Next qt
    Next WSh
End Sub
Sub deletarConexoes()
    Dim Conn As WorkbookConnection
    For Each Conn In ThisWorkbook.Connections
        Conn.Delete
    Next Conn
End Sub

Sub atualizar()
'
' Atualizar Macro

    Application.ScreenUpdating = False

    'Tira_as_Conexoes_do_Banco
    
    deletarQuerys
    deletarConsultas
    deletarConexoes
    
    'Achar_Ultima_Celula
    
    Dim ultimo
    Cells(100000, 3).Select
    Selection.End(xlUp).Select
    ultimo = ActiveCell.Row
    
    
    'Deletar_Infor_Anterior
    
    Rows("9:10000").Select
    Selection.Delete Shift:=xlUp
    If ultimo > 9 Then
        Range(Cells(9, 2), Cells(ultimo, 20)).Select
        Selection.ClearContents
    End If

    'Importa_os_Dados
    
    Range("A9").Select
    ActiveWorkbook.Queries.Add Name:="Consulta1", Formula:= _
        "let" & Chr(13) & "" & Chr(10) & "    Fonte = Odbc.Query(""dsn=DBCONTROL_3336_001"", ""SELECT DISTINCT A.CRMOVMOV_NDUPL AS 'NUM. TITULO', A.CRMOVMOV_CCLI AS 'COD. CLIENTE', C.VDCLICLI_RAZAO50 AS 'RAZÃO SOCIAL', CAST(RIGHT(CAST(A.CRMOVMOV_DTE AS VARCHAR(300)),2) || '/' || SUBSTRING(CAST(A.CRMOVMOV_DTE AS VARCHAR(300)),5,2) || '/' || LEFT(CAST(A.CRMOVMOV_DTE AS VARCHAR(300)),4) AS VARCHAR(300)) A" & _
        "S 'DATA EMISSAO', CAST(RIGHT(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),2) || '/' || SUBSTRING(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),5,2) || '/' || LEFT(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),4) AS VARCHAR(300)) AS 'DATA VENCIMENTO', DAYS_BETWEEN(CAST(LEFT(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),4) || SUBSTRING(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),5,2) || RIGHT(CAST(A.CRMOVMOV_" & _
        "DTV AS VARCHAR(300)),2) AS DATE),CURDATE()) AS DIAS, (CASE WHEN DAYS_BETWEEN(CAST(LEFT(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),4) || SUBSTRING(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),5,2) || RIGHT(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),2) AS DATE),CURDATE()) > 0 THEN 'V' ELSE 'AV' END) AS 'V/AV',D.VDVENVEN_SIGLA AS 'COD. VENDEDOR',#(lf)B.VDPEDPPT_TPCOBR AS 'TP. COBRANÇA', E" & _
        ".VDFATCFA_VALPRDORI AS 'VLR. ORIGINAL', A.CRMOVMOV_VALOR AS 'VLR. TITULO', (DAYS_BETWEEN(CAST(LEFT(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),4) || SUBSTRING(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),5,2) || RIGHT(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),2) AS DATE),CURDATE()) * 0.002 * A.CRMOVMOV_VALOR) AS JUROS, ((DAYS_BETWEEN(CAST(LEFT(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),4) ||" & _
        " SUBSTRING(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),5,2) || RIGHT(CAST(A.CRMOVMOV_DTV AS VARCHAR(300)),2) AS DATE),CURDATE()) * 0.002 * A.CRMOVMOV_VALOR) + A.CRMOVMOV_VALOR) AS 'VLR. TOTAL', D.VDVENVEN_SUPVD AS 'GA', C.VDCLICLI_CONTATO AS 'CONTATO', C.VDCLICLI_FONE AS 'TELEFONE 1', C.VDCLICLI_FONE2 AS 'TELEFONE 2', C.VDCLICLI_CEL1 AS 'TELEFONE 3', C.VDCLICLI_CEL2 AS 'TE" & _
        "LEFONE 4'#(lf)FROM CADMOV01 AS A#(lf)INNER JOIN NPEDPT01 AS B#(lf)ON A.CRMOVMOV_CCLI=B.VDPEDPPT_CODCLI#(lf)INNER JOIN CADCLI01 AS C#(lf)ON A.CRMOVMOV_CGC=C.VDCLICLI_CGC#(lf)INNER JOIN CADVEN01 AS D#(lf)ON A.CRMOVMOV_VEN=D.VDVENVEN_SIGLA#(lf)INNER JOIN NC211201 AS E#(lf)ON A.CRMOVMOV_NPED=E.VDFATCFA_NPED#(lf)WHERE B.VDPEDPPT_TPCOBR > 1"")" & Chr(13) & "" & Chr(10) & "in" & Chr(13) & "" & Chr(10) & "    Fonte" & _
        ""
    With ActiveSheet.ListObjects.Add(SourceType:=0, Source:= _
        "OLEDB;Provider=Microsoft.Mashup.OleDb.1;Data Source=$Workbook$;Location=Consulta1;Extended Properties=""""" _
        , Destination:=Range("$A$9")).QueryTable
        .CommandType = xlCmdSql
        .CommandText = Array("SELECT * FROM [Consulta1]")
        .RowNumbers = False
        .FillAdjacentFormulas = False
        .PreserveFormatting = True
        .RefreshOnFileOpen = False
        .BackgroundQuery = True
        .RefreshStyle = xlInsertDeleteCells
        .SavePassword = False
        .SaveData = True
        .AdjustColumnWidth = True
        .RefreshPeriod = 0
        .PreserveColumnInfo = True
        .ListObject.DisplayName = "Consulta1"
        .Refresh BackgroundQuery:=False
    End With
    
    'Formatacao_Planilha
    
    
    Range(Selection, Selection.End(xlToRight)).Select
    Range(Selection, Selection.End(xlDown)).Select
    ActiveSheet.ListObjects("Consulta1").TableStyle = "TableStyleMedium6"
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    Selection.Borders(xlEdgeLeft).LineStyle = xlNone
    Selection.Borders(xlEdgeTop).LineStyle = xlNone
    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
    Selection.Borders(xlEdgeRight).LineStyle = xlNone
    With Selection.Borders(xlInsideVertical)
        .LineStyle = xlDash
        .ColorIndex = xlAutomatic
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideHorizontal)
        .LineStyle = xlDash
        .ColorIndex = xlAutomatic
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Selection.Replace What:="   ", Replacement:="", LookAt:=xlPart, _
        SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, _
        ReplaceFormat:=False, FormulaVersion:=xlReplaceFormula2
        
        'Formatando_Colunas_Datas_e_Valor_Real
        
            Range("Consulta1[[#Headers],[DATA EMISSAO]]").Select
    Range(Selection, Selection.End(xlToRight)).Select
    Range(Selection, Selection.End(xlToLeft)).Select
    Range("Consulta1[[#Headers],[DATA EMISSAO]:[DATA VENCIMENTO]]").Select
    Range("Consulta1[[#Headers],[DATA VENCIMENTO]]").Activate
    Range(Selection, Selection.End(xlDown)).Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.NumberFormat = "m/d/yyyy"
    Range("Consulta1[[#Headers],[VLR. ORIGINAL]:[VLR. TOTAL]]").Select
    Range(Selection, Selection.End(xlDown)).Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.NumberFormat = "_($* #,##0.00_);_($* (#,##0.00);_($* ""-""??_);_(@_)"
    
    'Atualiza_Formato_Telefone
    
    Columns("O:O").Select
    Selection.ColumnWidth = 40.11
    Columns("O:O").EntireColumn.AutoFit
    Range("Consulta1[[#Headers],[TELEFONE 1]]").Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.NumberFormat = "(00) 0 0000-0000"
    Range("Consulta1[[#Headers],[TELEFONE 2]:[TELEFONE 4]]").Select
    Range(Selection, Selection.End(xlDown)).Select
    Range(Selection, Selection.End(xlDown)).Select
    Selection.NumberFormat = "(00) 0 0000-0000"
    
    'AutoFit_Colunas
    
        Range(Selection, Selection.End(xlToRight)).Select
        Range(Selection, Selection.End(xlDown)).Select
        Range(Selection, Selection.End(xlDown)).Select
        Columns("F:F").ColumnWidth = 6.33
        Columns("F:F").EntireColumn.AutoFit
        

        
    Application.ScreenUpdating = True
    MsgBox "Atualização finalizada"
End Sub


End Sub
